require=function e(t,r,n){function o(i,s){if(!r[i]){if(!t[i]){var p="function"==typeof require&&require;if(!s&&p)return p(i,!0);if(a)return a(i,!0);var u=new Error("Cannot find module '"+i+"'");throw u.code="MODULE_NOT_FOUND",u}var l=r[i]={exports:{}};t[i][0].call(l.exports,function(e){var r=t[i][1][e];return o(r?r:e)},l,l.exports,e,t,r,n)}return r[i].exports}for(var a="function"==typeof require&&require,i=0;i<n.length;i++)o(n[i]);return o}({1:[function(e,t){var r=e("./Grammar"),n=function(e,t,r){this._transforms=e||{},this._context=t||{},this._relContext=r||t};n.prototype.eval=function(e){var t=this;return Promise.resolve().then(function(){return t["_eval"+e.type].call(t,e)})},n.prototype.evalArray=function(e){return Promise.all(e.map(function(e){return this.eval(e)},this))},n.prototype.evalMap=function(e){var t=Object.keys(e),r={},n=t.map(function(t){return this.eval(e[t])},this);return Promise.all(n).then(function(e){return e.forEach(function(e,n){r[t[n]]=e}),r})},n.prototype._evalBinaryExpression=function(e){return Promise.all([this.eval(e.left),this.eval(e.right)]).then(function(t){return r.elements[e.operator].eval(t[0],t[1])})},n.prototype._evalFilterExpression=function(e){var t=this;return this.eval(e.subject).then(function(r){return e.relative?t._filterRelative(r,e.expr):t._filterStatic(r,e.expr)})},n.prototype._evalIdentifier=function(e){return e.from?this.eval(e.from).then(function(t){return void 0===t?void 0:(Array.isArray(t)&&(t=t[0]),t?t[e.value]:void 0)}):e.relative?this._relContext[e.value]:this._context[e.value]},n.prototype._evalLiteral=function(e){return e.value},n.prototype._evalObjectLiteral=function(e){return this.evalMap(e.value)},n.prototype._evalTransform=function(e){var t=this._transforms[e.name];if(!t)throw new Error("Transform '"+e.name+"' is not defined.");return Promise.all([this.eval(e.subject),this.evalArray(e.args||[])]).then(function(e){return t.apply(null,[e[0]].concat(e[1]))})},n.prototype._evalUnaryExpression=function(e){return this.eval(e.right).then(function(t){return r.elements[e.operator].eval(t)})},n.prototype._filterRelative=function(e,t){var r=[];return Array.isArray(e)||(e=[e]),e.forEach(function(e){var o=new n(this._transforms,this._context,e);r.push(o.eval(t))},this),Promise.all(r).then(function(t){var r=[];return t.forEach(function(t,n){t&&r.push(e[n])}),r})},n.prototype._filterStatic=function(e,t){return this.eval(t).then(function(t){return"boolean"==typeof t?t?e:void 0:e[t]})},t.exports=n},{"./Grammar":2}],2:[function(e,t,r){r.elements={".":{type:"dot"},"[":{type:"openBracket",balance:1},"]":{type:"closeBracket",balance:-1},"|":{type:"pipe"},"{":{type:"openCurl",balance:1},"}":{type:"closeCurl",balance:-1},":":{type:"colon"},",":{type:"comma"},"(":{type:"openParen",balance:1},")":{type:"closeParen",balance:-1},"+":{type:"binaryOp",weight:30,eval:function(e,t){return e+t}},"-":{type:"binaryOp",weight:30,eval:function(e,t){return e-t}},"*":{type:"binaryOp",weight:40,eval:function(e,t){return e*t}},"/":{type:"binaryOp",weight:40,eval:function(e,t){return e/t}},"//":{type:"binaryOp",weight:40,eval:function(e,t){return Math.floor(e/t)}},"%":{type:"binaryOp",weight:50,eval:function(e,t){return e%t}},"^":{type:"binaryOp",weight:50,eval:function(e,t){return Math.pow(e,t)}},"==":{type:"binaryOp",weight:20,eval:function(e,t){return e==t}},"!=":{type:"binaryOp",weight:20,eval:function(e,t){return e!=t}},">":{type:"binaryOp",weight:20,eval:function(e,t){return e>t}},">=":{type:"binaryOp",weight:20,eval:function(e,t){return e>=t}},"<":{type:"binaryOp",weight:20,eval:function(e,t){return t>e}},"<=":{type:"binaryOp",weight:20,eval:function(e,t){return t>=e}},"&&":{type:"binaryOp",weight:10,eval:function(e,t){return e&&t}},"||":{type:"binaryOp",weight:10,eval:function(e,t){return e||t}},"!":{type:"unaryOp",weight:60,eval:function(e){return!e}}}},{}],3:[function(e,t){var r,n=e("./Grammar"),o=n.elements,a=/^-?(?:(?:[0-9]*\.[0-9]+)|[0-9]+)$/,i=/^[a-zA-Z_\$][a-zA-Z0-9_\$]*$/,s=/\\\\/,p=["'(?:(?:\\\\')?[^'])*'",'"(?:(?:\\\\")?[^"])*"',"\\s+","\\btrue\\b","\\bfalse\\b","\\b[a-zA-Z_\\$][a-zA-Z0-9_\\$]*\\b","(?:(?:[0-9]*\\.[0-9]+)|[0-9]+)"],u=["binaryOp","unaryOp","openParen","openBracket","colon"],l={};l.getElements=function(e){var t=l._getSplitRegex();return e.split(t).filter(function(e){return e})},l.getTokens=function(e){for(var t=[],r=!1,n=0;n<e.length;n++)l._isWhitespace(e[n])?t.length&&(t[t.length-1].raw+=e[n]):"-"===e[n]&&l._isNegative(t)?r=!0:(r&&(e[n]="-"+e[n],r=!1),t.push(l._createToken(e[n])));return r&&t.push(l._createToken("-")),t},l.tokenize=function(e){var t=l.getElements(e);return l.getTokens(t)},l._createToken=function(e){var t={type:"literal",value:e,raw:e};if('"'==e[0]||"'"==e[0])t.value=l._unquote(e);else if(e.match(a))t.value=parseFloat(e);else if("true"===e||"false"===e)t.value="true"===e;else if(o[e])t.type=o[e].type;else{if(!e.match(i))throw new Error("Invalid expression token: "+e);t.type="identifier"}return t},l._escapeRegExp=function(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")},l._getSplitRegex=function(){if(!r){var e=Object.keys(o);e=e.sort(function(e,t){return t.length-e.length}).map(function(e){return l._escapeRegExp(e)}),r=new RegExp("("+p.join("|")+"|"+e.join("|")+")")}return r},l._isNegative=function(e){return e.length?u.some(function(t){return t===e[e.length-1].type}):!0},l._isWhitespace=function(e){for(var t=0;t<e.length;t++)if(" "!=e[t])return!1;return!0},l._unquote=function(e){var t=e[0],r=new RegExp("\\\\"+t,"g");return e.substr(1,e.length-2).replace(r,t).replace(s,"\\")},t.exports=l},{"./Grammar":2}],4:[function(e,t){function r(e){this._state="expectOperand",this._tree=null,this._exprStr=e||"",this._relative=!1,this._balance=0,this._subMarker=null}var n=e("./Grammar").elements,o={expectOperand:{tokenTypes:{literal:{toState:"expectBinOp"},identifier:{toState:"identifier"},unaryOp:{},openParen:{toState:"subExpression"},openCurl:{toState:"expectObjKey",handler:"objStart"},dot:{toState:"traverse"}}},expectBinOp:{tokenTypes:{binaryOp:{toState:"expectOperand"},pipe:{toState:"expectTransform"},dot:{toState:"traverse"}},completable:!0},expectTransform:{tokenTypes:{identifier:{toState:"postTransform",handler:"transform"}}},expectObjKey:{tokenTypes:{identifier:{toState:"expectKeyValSep",handler:"objKey"},closeCurl:{toState:"expectBinOp"}}},expectKeyValSep:{tokenTypes:{colon:{toState:"objVal"}}},postTransform:{tokenTypes:{openParen:{toState:"argVal"},binaryOp:{toState:"expectOperand"},dot:{toState:"traverse"},openBracket:{toState:"filter"},pipe:{toState:"expectTransform"}},completable:!0},postTransformArgs:{tokenTypes:{binaryOp:{toState:"expectOperand"},dot:{toState:"traverse"},openBracket:{toState:"filter"},pipe:{toState:"expectTransform"}},completable:!0},identifier:{tokenTypes:{binaryOp:{toState:"expectOperand"},dot:{toState:"traverse"},openBracket:{toState:"filter"},pipe:{toState:"expectTransform"}},completable:!0},traverse:{tokenTypes:{identifier:{toState:"identifier"}}},filter:{subHandler:"filter",endStates:{closeBracket:"identifier"}},subExpression:{subHandler:"subExpression",endStates:{closeParen:"expectBinOp"}},argVal:{subHandler:"argVal",endStates:{comma:"argVal",closeParen:"postTransformArgs"}},objVal:{subHandler:"objVal",endStates:{comma:"expectObjKey",closeCurl:"expectBinOp"}}},a="_handle_";r.prototype.addToken=function(e){if(this._complete)throw new Error("Cannot add a new token to a completed Parser");this._exprStr+=e.raw;var t=n[e.value],r=this._balance;t&&(this._balance+=n[e.value].balance||0);var i=o[this._state];if(i.subHandler)if(null===this._subMarker&&this._startSubExpression(r),r===this._subMarker&&i.endStates[e.type]){var s=this._subParser.complete();this[a+i.subHandler].call(this,s,e),this._state=i.endStates[e.type],this._subMarker=null}else this._subParser.addToken(e);else{if(!i.tokenTypes[e.type])throw new Error("Token "+e.raw+" ("+e.type+") unexpected in expression: "+this._exprStr);var p=i.tokenTypes[e.type],u=this[a+e.type];p.handler&&(u=this[a+p.handler]),u&&u.call(this,e),p.toState&&(this._state=p.toState)}},r.prototype.addTokens=function(e){e.forEach(this.addToken,this)},r.prototype.complete=function(){if(!o[this._state].completable)throw new Error("Unexpected end of expression: "+this._exprStr);return this._complete=!0,this._tree},r.prototype.isRelative=function(){return this._relative},r.prototype._handle_argVal=function(e){this._cursor.args.push(e)},r.prototype._handle_binaryOp=function(e){for(var t=n[e.value].weight||0,r=this._cursor._parent;r&&r.operator&&n[r.operator].weight>=t;)this._cursor=r,r=r._parent;var o={type:"BinaryExpression",operator:e.value,left:this._cursor};this._setParent(this._cursor,o),this._cursor=r,this._placeAtCursor(o)},r.prototype._handle_dot=function(){this._nextIdentEncapsulate=this._cursor&&("BinaryExpression"!=this._cursor.type||"BinaryExpression"==this._cursor.type&&this._cursor.right)&&"UnaryExpression"!=this._cursor.type,this._nextIdentRelative=!this._cursor||this._cursor&&!this._nextIdentEncapsulate,this._nextIdentRelative&&(this._relative=!0)},r.prototype._handle_filter=function(e){this._placeBeforeCursor({type:"FilterExpression",expr:e,relative:this._subParser.isRelative(),subject:this._cursor})},r.prototype._handle_identifier=function(e){var t={type:"Identifier",value:e.value};this._nextIdentEncapsulate?(t.from=this._cursor,this._placeBeforeCursor(t)):(this._nextIdentRelative&&(t.relative=!0),this._placeAtCursor(t))},r.prototype._handle_literal=function(e){this._placeAtCursor({type:"Literal",value:e.value})},r.prototype._handle_objKey=function(e){this._curObjKey=e.value},r.prototype._handle_objStart=function(){this._placeAtCursor({type:"ObjectLiteral",value:{}})},r.prototype._handle_objVal=function(e){this._cursor.value[this._curObjKey]=e},r.prototype._handle_subExpression=function(e){this._placeAtCursor(e)},r.prototype._handle_transform=function(e){this._placeBeforeCursor({type:"Transform",name:e.value,args:[],subject:this._cursor})},r.prototype._handle_unaryOp=function(e){this._placeAtCursor({type:"UnaryExpression",operator:e.value})},r.prototype._placeAtCursor=function(e){this._cursor?(this._cursor.right=e,this._setParent(e,this._cursor)):this._tree=e,this._cursor=e},r.prototype._placeBeforeCursor=function(e){this._cursor=this._cursor._parent,this._placeAtCursor(e)},r.prototype._setParent=function(e,t){Object.defineProperty(e,"_parent",{value:t,writable:!0})},r.prototype._startSubExpression=function(e){var t=this._exprStr.substr(0,this._exprStr.length-1);this._subParser=new r(t),this._subMarker=e},t.exports=r},{"./Grammar":2}],Jexl:[function(e,t){function r(){this._transforms={}}var n=e("./Evaluator"),o=e("./Lexer"),a=e("./Parser");r.prototype.addTransform=function(e,t){this._transforms[e]=t},r.prototype.addTransforms=function(e){for(var t in e)e.hasOwnProperty(t)&&(this._transforms[t]=e[t])},r.prototype.getTransform=function(e){return this._transforms[e]},r.prototype.eval=function(e,t,r){"function"==typeof t?(r=t,t={}):t||(t={});var n=this._eval(e,t);if(r){var o=!1;return n.then(function(e){o=!0,setTimeout(r.bind(null,null,e),0)})["catch"](function(e){o||setTimeout(r.bind(null,e),0)})}return n},r.prototype._eval=function(e,t){var r=new a,i=new n(this._transforms,t);return Promise.resolve().then(function(){return r.addTokens(o.tokenize(e)),i.eval(r.complete())})},t.exports=new r,t.exports.Jexl=r},{"./Evaluator":1,"./Lexer":3,"./Parser":4}]},{},[]);