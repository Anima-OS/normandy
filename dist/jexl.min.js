require=function t(e,r,n){function a(o,s){if(!r[o]){if(!e[o]){var p="function"==typeof require&&require;if(!s&&p)return p(o,!0);if(i)return i(o,!0);var u=new Error("Cannot find module '"+o+"'");throw u.code="MODULE_NOT_FOUND",u}var l=r[o]={exports:{}};e[o][0].call(l.exports,function(t){var r=e[o][1][t];return a(r?r:t)},l,l.exports,t,e,r,n)}return r[o].exports}for(var i="function"==typeof require&&require,o=0;o<n.length;o++)a(n[o]);return a}({1:[function(t,e){var r=t("./Grammar"),n=function(t,e,r){this._transforms=t||{},this._context=e||{},this._relContext=r||e};n.prototype.eval=function(t){var e=this;return Promise.resolve().then(function(){return e["_eval"+t.type].call(e,t)})},n.prototype.evalMap=function(t){var e=Object.keys(t),r={},n=e.map(function(e){return this.eval(t[e])},this);return Promise.all(n).then(function(t){return t.forEach(function(t,n){r[e[n]]=t}),r})},n.prototype._evalBinaryExpression=function(t){return Promise.all([this.eval(t.left),this.eval(t.right)]).then(function(e){return r.elements[t.operator].eval(e[0],e[1])})},n.prototype._evalFilterExpression=function(t){var e=this;return this.eval(t.subject).then(function(r){return t.relative?e._filterRelative(r,t.expr):e._filterStatic(r,t.expr)})},n.prototype._evalIdentifier=function(t){return t.from?this.eval(t.from).then(function(e){return void 0===e?void 0:(Array.isArray(e)&&(e=e[0]),e?e[t.value]:void 0)}):t.relative?this._relContext[t.value]:this._context[t.value]},n.prototype._evalLiteral=function(t){return t.value},n.prototype._evalTransform=function(t){var e=this._transforms[t.name];if(!e)throw new Error("Transform '"+t.name+"' is not defined.");return Promise.all([this.eval(t.subject),this.evalMap(t.args||{})]).then(function(t){return e(t[0],t[1])})},n.prototype._evalUnaryExpression=function(t){return this.eval(t.right).then(function(e){return r.elements[t.operator].eval(e)})},n.prototype._filterRelative=function(t,e){var r=[];return Array.isArray(t)||(t=[t]),t.forEach(function(t){var a=new n(this._transforms,this._context,t);r.push(a.eval(e))},this),Promise.all(r).then(function(e){var r=[];return e.forEach(function(e,n){e&&r.push(t[n])}),r})},n.prototype._filterStatic=function(t,e){return this.eval(e).then(function(e){return"boolean"==typeof e?e?t:void 0:t[e]})},e.exports=n},{"./Grammar":2}],2:[function(t,e,r){r.elements={identTraverse:{str:"."},filterStart:{str:"["},filterEnd:{str:"]"},transformStart:{str:"|"},transformArgsStart:{str:"{"},transformArgsEnd:{str:"}"},transformKeyValSep:{str:":"},transformKeyValPairSep:{str:","},groupStart:{str:"("},groupEnd:{str:")"},binOpAddConcat:{str:"+",type:"binaryOp",weight:30,eval:function(t,e){return t+e}},binOpSub:{str:"-",type:"binaryOp",weight:30,eval:function(t,e){return t-e}},binOpMult:{str:"*",type:"binaryOp",weight:40,eval:function(t,e){return t*e}},binOpDiv:{str:"/",type:"binaryOp",weight:40,eval:function(t,e){return t/e}},binOpDivFloor:{str:"//",type:"binaryOp",weight:40,eval:function(t,e){return Math.floor(t/e)}},binOpMod:{str:"%",type:"binaryOp",weight:50,eval:function(t,e){return t%e}},binOpPow:{str:"^",type:"binaryOp",weight:50,eval:function(t,e){return Math.pow(t,e)}},binOpCmpEq:{str:"==",type:"binaryOp",weight:20,eval:function(t,e){return t==e}},binOpCmpNeq:{str:"!=",type:"binaryOp",weight:20,eval:function(t,e){return t!=e}},binOpCmpGt:{str:">",type:"binaryOp",weight:20,eval:function(t,e){return t>e}},binOpCmpGte:{str:">=",type:"binaryOp",weight:20,eval:function(t,e){return t>=e}},binOpCmpLt:{str:"<",type:"binaryOp",weight:20,eval:function(t,e){return e>t}},binOpCmpLte:{str:"<=",type:"binaryOp",weight:20,eval:function(t,e){return e>=t}},binOpLogicAnd:{str:"&&",type:"binaryOp",weight:10,eval:function(t,e){return t&&e}},binOpLogicOr:{str:"||",type:"binaryOp",weight:10,eval:function(t,e){return t||e}},unOpNegate:{str:"!",type:"unaryOp",weight:60,eval:function(t){return!t}}},r.elementNames={};for(var n in r.elements)r.elements.hasOwnProperty(n)&&(r.elementNames[r.elements[n].str]=n)},{}],3:[function(t,e){var r,n=t("./Grammar"),a=(n.elements,n.elementNames),i=/^-?(?:(?:[0-9]*\.[0-9]+)|[0-9]+)$/,o=/^[a-zA-Z_\$][a-zA-Z0-9_\$]*$/,s=/\\\\/,p=["'(?:(?:\\\\')?[^'])*'",'"(?:(?:\\\\")?[^"])*"',"\\s+","\\btrue\\b","\\bfalse\\b","\\b[a-zA-Z_\\$][a-zA-Z0-9_\\$]*\\b","(?:(?:[0-9]*\\.[0-9]+)|[0-9]+)"],u=["binaryOp","unaryOp","groupStart","drillStart","transformKeyValSep"],l={};l.getElements=function(t){var e=l._getSplitRegex();return t.split(e).filter(function(t){return t})},l.getTokens=function(t){for(var e=[],r=!1,n=0;n<t.length;n++)l._isWhitespace(t[n])?e.length&&(e[e.length-1].raw+=t[n]):"-"===t[n]&&l._isNegative(e)?r=!0:(r&&(t[n]="-"+t[n],r=!1),e.push(l._createToken(t[n])));return r&&e.push(l._createToken("-")),e},l.tokenize=function(t){var e=l.getElements(t);return l.getTokens(e)},l._createToken=function(t){var e=a[t],r={type:"literal",value:t,raw:t};if('"'==t[0]||"'"==t[0])r.value=l._unquote(t);else if(t.match(i))r.value=parseFloat(t);else if("true"===t||"false"===t)r.value="true"===t;else if(e)r.type=n.elements[e].type||e,r.name=e;else{if(!t.match(o))throw new Error("Invalid expression token: "+t);r.type="identifier"}return r},l._escapeRegExp=function(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")},l._getSplitRegex=function(){if(!r){var t=[];for(var e in n.elements)n.elements.hasOwnProperty(e)&&t.push(n.elements[e].str);t=t.sort(function(t,e){return e.length-t.length}).map(function(t){return l._escapeRegExp(t)}),r=new RegExp("("+p.join("|")+"|"+t.join("|")+")")}return r},l._isNegative=function(t){return t.length?u.some(function(e){return e===t[t.length-1].type}):!0},l._isWhitespace=function(t){for(var e=0;e<t.length;e++)if(" "!=t[e])return!1;return!0},l._unquote=function(t){var e=t[0],r=new RegExp("\\\\"+e,"g");return t.substr(1,t.length-2).replace(r,e).replace(s,"\\")},e.exports=l},{"./Grammar":2}],4:[function(t,e){function r(t){this._state="expectOperand",this._tree=null,this._exprStr=t||"",this._relative=!1}var n=t("./Grammar"),a={expectOperand:{tokenTypes:{literal:{toState:"expectBinOp"},identifier:{toState:"identifier"},unaryOp:{},groupStart:{toState:"subExpression"},identTraverse:{toState:"identTraverse"}}},expectBinOp:{tokenTypes:{binaryOp:{toState:"expectOperand"},transformStart:{toState:"expectTransform"}},completable:!0},expectTransform:{tokenTypes:{identifier:{toState:"postTransform",handler:"_handle_transform"}}},expectArgKey:{tokenTypes:{identifier:{toState:"expectKeyValSep",handler:"_handle_argKey"},transformArgsEnd:{toState:"postTransform"}}},expectKeyValSep:{tokenTypes:{transformKeyValSep:{toState:"argVal"}}},postTransform:{tokenTypes:{transformArgsStart:{toState:"expectArgKey"},binaryOp:{toState:"expectOperand"},identTraverse:{toState:"identTraverse"},filterStart:{toState:"filter"},transformStart:{toState:"expectTransform"}},completable:!0},identifier:{tokenTypes:{binaryOp:{toState:"expectOperand"},identTraverse:{toState:"identTraverse"},filterStart:{toState:"filter"},transformStart:{toState:"expectTransform"}},completable:!0},identTraverse:{tokenTypes:{identifier:{toState:"identifier"}}},filter:{handler:"_handle_filter",stateOnTrue:"identifier"},subExpression:{handler:"_handle_subExpression",stateOnTrue:"expectBinOp"},argVal:{handler:"_handle_argVal"}};r.prototype.addToken=function(t){if(this._complete)throw new Error("Cannot add a new token to a completed Parser");this._exprStr+=t.raw;var e=a[this._state];if(e.handler){var r=this[e.handler].call(this,t);e.stateOnTrue&&r&&(this._state=e.stateOnTrue)}else{if(!e.tokenTypes[t.type])throw new Error("Token "+t.raw+" ("+t.type+") unexpected in expression: "+this._exprStr);var n=e.tokenTypes[t.type],i=this["_handle_"+t.type];n.handler&&(i=this[n.handler]),i&&i.call(this,t),n.toState&&(this._state=n.toState)}},r.prototype.addTokens=function(t){t.forEach(this.addToken,this)},r.prototype.complete=function(){if(!a[this._state].completable)throw new Error("Unexpected end of expression: "+this._exprStr);return this._complete=!0,this._tree},r.prototype.isRelative=function(){return this._relative},r.prototype._handle_argKey=function(t){this._curArgKey=t.value},r.prototype._handle_argVal=function(t){"transformArgsStart"==t.type?this._subTracker++:"transformArgsEnd"==t.type&&this._subTracker--,-1==this._subTracker||0==this._subTracker&&"transformKeyValPairSep"==t.type?(this._cursor.args[this._curArgKey]=this._subParser.complete(),"transformKeyValPairSep"==t.type?this._state="expectArgKey":"transformArgsEnd"==t.type&&(this._state="identifier")):this._subParser.addToken(t)},r.prototype._handle_binaryOp=function(t){for(var e=n.elements[t.name].weight||0,r=this._cursor._parent;r&&r.operator&&n.elements[r.operator].weight>=e;)this._cursor=r,r=r._parent;var a={type:"BinaryExpression",operator:t.name,left:this._cursor};this._setParent(this._cursor,a),this._cursor=r,this._placeAtCursor(a)},r.prototype._handle_filter=function(t){if("filterStart"==t.type?this._subTracker++:"filterEnd"==t.type&&this._subTracker--,0==this._subTracker){var e={type:"FilterExpression",expr:this._subParser.complete(),relative:this._subParser.isRelative(),subject:this._cursor};return this._placeBeforeCursor(e),!0}return this._subParser.addToken(t),!1},r.prototype._handle_filterStart=function(){this._startSubExpression(1)},r.prototype._handle_groupStart=function(){this._startSubExpression(1)},r.prototype._handle_identifier=function(t){var e={type:"Identifier",value:t.value};this._nextIdentEncapsulate?(e.from=this._cursor,this._placeBeforeCursor(e)):(this._nextIdentRelative&&(e.relative=!0),this._placeAtCursor(e))},r.prototype._handle_identTraverse=function(){this._nextIdentEncapsulate=this._cursor&&("Identifier"==this._cursor.type||"FilterExpression"==this._cursor.type||"Transform"==this._cursor.type),this._nextIdentRelative=!this._cursor||this._cursor&&!this._nextIdentEncapsulate,this._nextIdentRelative&&(this._relative=!0)},r.prototype._handle_literal=function(t){this._placeAtCursor({type:"Literal",value:t.value})},r.prototype._handle_subExpression=function(t){return"groupStart"==t.type?this._subTracker++:"groupEnd"==t.type&&this._subTracker--,0==this._subTracker?(this._placeAtCursor(this._subParser.complete()),!0):(this._subParser.addToken(t),!1)},r.prototype._handle_transform=function(t){var e={type:"Transform",name:t.value,subject:this._cursor};this._placeBeforeCursor(e)},r.prototype._handle_transformArgsStart=function(){this._cursor.args={}},r.prototype._handle_transformKeyValSep=function(){this._startSubExpression(0)},r.prototype._handle_unaryOp=function(t){this._placeAtCursor({type:"UnaryExpression",operator:t.name})},r.prototype._placeAtCursor=function(t){this._cursor?(this._cursor.right=t,this._setParent(t,this._cursor)):this._tree=t,this._cursor=t},r.prototype._placeBeforeCursor=function(t){this._cursor=this._cursor._parent,this._placeAtCursor(t)},r.prototype._setParent=function(t,e){Object.defineProperty(t,"_parent",{value:e,writable:!0})},r.prototype._startSubExpression=function(t){this._subParser=new r(this._exprStr),this._subTracker=t},e.exports=r},{"./Grammar":2}],Jexl:[function(t,e){function r(){this._transforms={}}var n=t("./Evaluator"),a=t("./Lexer"),i=t("./Parser");r.prototype.addTransform=function(t,e){this._transforms[t]=e},r.prototype.addTransforms=function(t){for(var e in t)t.hasOwnProperty(e)&&(this._transforms[e]=t[e])},r.prototype.getTransform=function(t){return this._transforms[t]},r.prototype.eval=function(t,e,r){"function"==typeof e?(r=e,e={}):e||(e={});var n=this._eval(t,e);if(r){var a=!1;return n.then(function(t){a=!0,setTimeout(r.bind(null,null,t),0)})["catch"](function(t){a||setTimeout(r.bind(null,t),0)})}return n},r.prototype._eval=function(t,e){var r=new i,o=new n(this._transforms,e);return Promise.resolve().then(function(){return r.addTokens(a.tokenize(t)),o.eval(r.complete())})},e.exports=new r,e.exports.Jexl=r},{"./Evaluator":1,"./Lexer":3,"./Parser":4}]},{},[]);